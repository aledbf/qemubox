# Beacon Containerd Runtime - Task Runner
#
# Quick Start:
#   task build           # Build everything (shim, kernel, initrd)
#   task clean           # Clean build artifacts
#   task lint            # Lint code
#
# Development:
#   task shell           # Enter development shell
#   task menuconfig      # Configure kernel (requires KERNEL_VERSION and KERNEL_ARCH)
#
# Requirements:
#   - Go 1.23+
#   - Docker with buildx

version: '3'

silent: true

output: "prefixed"

vars:
  GO: go
  DOCKER: docker
  BUILDX: "{{.DOCKER}} buildx"
  MODULE_NAME:
    sh: go list -m
  ARCH:
    sh: uname -m
  OS:
    sh: uname -s

  # Build flags
  LDFLAGS: "-s -w"
  GO_BUILDTAGS: "no_grpc"
  GO_TAGS: '-tags "{{.GO_BUILDTAGS}}"'
  GO_LDFLAGS: "-ldflags '{{.LDFLAGS}}'"

  # Static build flags
  GO_STATIC_BUILDTAGS: "osusergo netgo static_build no_grpc"
  GO_STATIC_TAGS: '-tags "{{.GO_STATIC_BUILDTAGS}}"'
  GO_STATIC_LDFLAGS: "-ldflags '-extldflags \"-static\" {{.LDFLAGS}}'"

tasks:
  # ==========================================================================
  # Build Tasks
  # ==========================================================================

  build:
    desc: Build all components (shim, kernel, initrd)
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Building all components..."
        {{.BUILDX}} bake
        echo "‚úì Build complete"

  build:shim:
    desc: Build containerd shim binary (static, Linux x86_64)
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Building containerd-shim-beaconbox-v1..."
        mkdir -p _output
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 {{.GO}} build {{.GO_STATIC_TAGS}} {{.GO_STATIC_LDFLAGS}} -o _output/containerd-shim-beaconbox-v1 ./cmd/containerd-shim-beaconbox-v1
        echo "‚úì Shim built: _output/containerd-shim-beaconbox-v1 (static)"

  build:vminitd:
    desc: Build vminitd binary (static, Linux x86_64)
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Building vminitd..."
        mkdir -p _output
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 {{.GO}} build {{.GO_STATIC_TAGS}} {{.GO_STATIC_LDFLAGS}} -o _output/vminitd ./cmd/vminitd
        echo "‚úì vminitd built: _output/vminitd (static)"

  build:initrd:
    desc: Build initrd image
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Building initrd..."
        {{.BUILDX}} bake initrd
        echo "‚úì Initrd built: _output/beacon-initrd"

  build:kernel:
    desc: Build kernel
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Building kernel..."
        {{.BUILDX}} bake kernel
        echo "‚úì Kernel built"

  # ==========================================================================
  # Development Tasks
  # ==========================================================================

  shell:
    desc: Enter development shell
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Building dev environment..."
        {{.BUILDX}} bake dev
        echo "üê≥ Starting development shell..."
        {{.DOCKER}} run --rm -it --privileged \
          --name beacon-dev \
          -v ./:/go/src/{{.MODULE_NAME}} \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -w /go/src/{{.MODULE_NAME}} \
          -e KERNEL_ARCH={{.ARCH}} \
          -e KERNEL_NPROC \
          beacon-dev

  menuconfig:
    desc: Configure kernel (requires KERNEL_VERSION and KERNEL_ARCH env vars)
    preconditions:
      - sh: "[ -n \"${KERNEL_VERSION:-}\" ]"
        msg: "KERNEL_VERSION environment variable must be set"
      - sh: "[ -n \"${KERNEL_ARCH:-}\" ]"
        msg: "KERNEL_ARCH environment variable must be set"
    interactive: true
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Building menuconfig environment..."
        {{.BUILDX}} bake menuconfig
        echo "üê≥ Starting kernel menuconfig..."
        echo "   Use arrow keys to navigate, Space to select, Enter to confirm"
        echo "   Press '/' to search for options"
        echo ""
      - |
        {{.DOCKER}} run --rm -it \
          -v ./kernel:/config \
          -w /usr/src/linux \
          -e KCONFIG_CONFIG=/config/config-${KERNEL_VERSION}-${KERNEL_ARCH} \
          -e TERM=${TERM:-xterm-256color} \
          beacon-menuconfig \
          bash -c "make ARCH=${KERNEL_ARCH} menuconfig && cp .config /config/config-${KERNEL_VERSION}-${KERNEL_ARCH}"

  # ==========================================================================
  # Validation Tasks
  # ==========================================================================

  validate:
    desc: Run all validation checks
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Running validation..."
        {{.BUILDX}} bake validate
        echo "‚úì Validation passed"

  lint:
    desc: Lint code
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Running linters..."
        {{.BUILDX}} bake lint
        echo "‚úì Linting passed"

  # ==========================================================================
  # Protobuf Tasks (optional)
  # ==========================================================================

  protos:
    desc: Generate protobuf files
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Generating protobufs..."
        cd api && PATH="$(pwd)/../bin:${PATH}" protobuild --quiet $(go list -m)/api/...
        go-fix-acronym -w -a '^Os' $(find api/ -name '*.pb.go')
        go-fix-acronym -w -a '(Id|Io|Uuid|Os)$$' $(find api/ -name '*.pb.go')
        echo "‚úì Protobufs generated"

  check:protos:
    desc: Check if protobufs need regeneration
    cmds:
      - task: protos
      - |
        set -eou pipefail
        echo "üê≥ Checking protobuf changes..."
        if [ -n "$(git status --short | grep '.pb.go')" ]; then
          echo "üëπ Error: Protobuf files are out of date"
          echo "   Run 'task protos' to regenerate"
          exit 1
        fi
        echo "‚úì Protobufs are up to date"

  # ==========================================================================
  # Cleanup Tasks
  # ==========================================================================

  clean:
    desc: Clean build artifacts
    cmds:
      - |
        set -eou pipefail
        echo "üßπ Cleaning build artifacts..."
        rm -rf _output
        echo "‚úì Clean complete"

  # ==========================================================================
  # Utility Tasks
  # ==========================================================================

  verify:vendor:
    desc: Verify go.mod/go.sum are up to date
    cmds:
      - |
        set -eou pipefail
        echo "üê≥ Verifying vendor files..."
        TMPDIR=$(mktemp -d)
        trap "rm -rf $TMPDIR" EXIT

        cp -R . $TMPDIR/beacon
        cd $TMPDIR/beacon
        {{.GO}} mod tidy
        {{.GO}} mod verify

        if ! diff -r go.mod go.sum {{.ROOT_DIR}}/; then
          echo "üëπ Error: go.mod or go.sum are out of date"
          echo "   Run 'go mod tidy' to update"
          exit 1
        fi

        echo "‚úì Vendor files are up to date"

  # ==========================================================================
  # All-in-one Tasks
  # ==========================================================================

  all:
    desc: Build and validate everything
    cmds:
      - task: build
      - task: validate
      - echo "‚úì All tasks complete"

  default:
    desc: Default task (build everything)
    cmds:
      - task: build

  # ==========================================================================
  # Release Tasks
  # ==========================================================================

  release:
    desc: Create release tarball with proper directory structure
    cmds:
      - task: build
      - |
        set -eou pipefail
        echo "üì¶ Creating release tarball..."

        # Determine version from git tag or use "dev"
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        RELEASE_NAME="beacon-${VERSION}-linux-x86_64"
        RELEASE_DIR="_output/release/${RELEASE_NAME}"

        # Clean and create release directory structure
        rm -rf _output/release
        mkdir -p "${RELEASE_DIR}/usr/share/beacon"
        mkdir -p "${RELEASE_DIR}/var/lib/beacon/bin"

        echo "üìÇ Copying artifacts to release structure..."

        # Copy kernel and initrd to /usr/share/beacon
        if [ -f "_output/beacon-kernel-x86_64" ]; then
          cp _output/beacon-kernel-x86_64 "${RELEASE_DIR}/usr/share/beacon/"
          echo "  ‚úì beacon-kernel-x86_64"
        fi

        if [ -f "_output/beacon-initrd" ]; then
          cp _output/beacon-initrd "${RELEASE_DIR}/usr/share/beacon/"
          echo "  ‚úì beacon-initrd"
        fi

        # Copy shim binary to /usr/share/beacon
        if [ -f "_output/containerd-shim-beaconbox-v1" ]; then
          cp _output/containerd-shim-beaconbox-v1 "${RELEASE_DIR}/usr/share/beacon/"
          echo "  ‚úì containerd-shim-beaconbox-v1"
        fi

        # Copy cloud-hypervisor if available
        if [ -f "_output/cloud-hypervisor" ]; then
          cp _output/cloud-hypervisor "${RELEASE_DIR}/var/lib/beacon/bin/"
          echo "  ‚úì cloud-hypervisor"
        fi

        # Create tarball
        echo "üóúÔ∏è  Creating tarball..."
        cd _output/release
        tar czf "${RELEASE_NAME}.tar.gz" "${RELEASE_NAME}"
        cd ../..

        echo "‚úì Release created: _output/release/${RELEASE_NAME}.tar.gz"
        echo ""
        echo "Installation:"
        echo "  tar xzf ${RELEASE_NAME}.tar.gz"
        echo "  cd ${RELEASE_NAME}"
        echo "  sudo cp -r usr /usr"
        echo "  sudo cp -r var /var"
